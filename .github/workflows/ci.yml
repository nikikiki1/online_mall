name: Online Mall CI/CD Pipeline

# 触发条件：代码推送到main分支或有人向main分支发起Pull Request时触发
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

# 工作流中的任务定义
jobs:
  # 单元测试任务
  unit-tests:
    name: 单元测试 (Unit Tests)
    # 运行在最新版本的Ubuntu环境中
    runs-on: ubuntu-latest
    
    # 任务步骤
    steps:
    # 1. 检出代码仓库
    - name: 检出代码仓库
      uses: actions/checkout@v4
      
    # 2. 设置Python环境，使用3.11版本
    - name: 设置Python 3.11环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    # 3. 安装项目依赖和测试工具
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov
        
    # 4. 运行单元测试并生成覆盖率报告
    - name: 运行单元测试
      run: |
        pytest tests/ -v --cov=. --cov-report=xml --cov-report=html
        
    # 5. 上传测试覆盖率报告到GitHub
    - name: 上传覆盖率报告
      uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage.xml
        fail_ci_if_error: true
        
  # 集成测试任务
  integration-tests:
    name: 集成测试 (Integration Tests)
    # 同样运行在最新版本的Ubuntu环境中
    runs-on: ubuntu-latest
    
    # 步骤
    steps:
    # 1. 检出代码仓库
    - name: 检出代码仓库
      uses: actions/checkout@v4
      
    # 2. 设置Python环境
    - name: 设置Python 3.11环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    # 3. 安装依赖
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install pytest
        
    # 4. 运行集成测试
    - name: 运行集成测试
      run: |
        python integration_tests.py
        
    # 5. 生成集成测试报告（可选：可以上传到GitHub）
    - name: 生成集成测试报告
      if: always()
      run: |
        mkdir -p reports
        cp 集成测试分析报告.md reports/integration_tests_report.md || echo "报告文件不存在"
        
    # 6. 上传集成测试报告
    - name: 上传集成测试报告
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: integration-test-reports
        path: reports/
        
  # 代码质量检查任务
  code-quality:
    name: 代码质量检查
    runs-on: ubuntu-latest
    
    steps:
    # 1. 检出代码仓库
    - name: 检出代码仓库
      uses: actions/checkout@v4
      
    # 2. 设置Python环境
    - name: 设置Python 3.11环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    # 3. 安装代码质量工具
    - name: 安装代码质量工具
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pylint mypy
        
    # 4. 运行flake8检查
    - name: 运行flake8代码风格检查
      run: |
        flake8 --max-line-length=120 --ignore=E501,W503 services/ models/ || true
        
    # 5. 运行pylint检查
    - name: 运行pylint代码质量检查
      run: |
        pylint services/ models/ --exit-zero || true
        
    # 6. 运行mypy类型检查
    - name: 运行mypy类型检查
      run: |
        mypy services/ models/ || true