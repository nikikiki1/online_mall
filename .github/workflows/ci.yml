name: Online Mall CI/CD Pipeline

# 触发条件：代码推送到main分支或有人向main分支发起Pull Request时触发
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

# 工作流中的任务定义
jobs:
  # 单元测试任务
  unit-tests:
    name: 单元测试 (Unit Tests)
    # 运行在最新版本的Ubuntu环境中
    runs-on: ubuntu-latest
    
    # 任务步骤
    steps:
    # 1. 检出代码仓库
    - name: 检出代码仓库
      uses: actions/checkout@v4
      
    # 2. 设置Python环境，使用3.11版本
    - name: 设置Python 3.11环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    # 3. 安装项目依赖和测试工具
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov
        
    # 4. 运行单元测试并生成覆盖率报告
    - name: 运行单元测试
      run: |
        pytest tests/ -v --cov=. --cov-report=xml --cov-report=html
        
    # 5. 上传测试覆盖率报告到GitHub
    - name: 上传覆盖率报告
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        fail_ci_if_error: false
        
